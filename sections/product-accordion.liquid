{% assign productMetaAccordionsSize = product.metafields.accordion.image | size %}
{% if productMetaAccordionsSize > 1 %}
  
{{ 'product-accordion.css' | asset_url | stylesheet_tag }}
<style>
  {{ section.settings.add_css }}
</style>
<style>
  {% if section.settings.bg_image != blank %}
  #product_accordion--{{ section.id }} {
      background-image: url({{ section.settings.bg_image | img_url: 'master' }});
  }
  {% else %}
  #product_accordion--{{ section.id }} {
      background:{{ section.settings.bg_color }};
  }
  {% endif %}
</style>

<div class="product_accordion {{ section.settings.add_class }}" id="product_accordion--{{ section.id }}">
  <div class="{% if section.settings.full_width == false %} page-width {% endif %} ">
    <div class="product_accordion_wrapper">
      <div class="product_accordion_main left_item small-hide">
        <div class="image_wrapper">
          {% if section.settings.image_title != blank -%}
            <div class="title small-hide">{{ section.settings.image_title }}</div>
          {% endif %}          
          {% assign productMetaAccordions = product.metafields.accordion.image %}    
          {% if productMetaAccordionsSize > 1 %}
          {% for metaImage in productMetaAccordions %}
            <div class="image js-image " for="item--{{ forloop.index0 }}" {% if forloop.index > 0 %}style="display:none"{% endif %}>
              <img src="{{ metaImage[0].original_src }}" alt="{{ block.settings.image.alt }}" image-index="{{ forloop.index0 }}">
            </div>
          {% endfor %}
          {% endif %}  
        </div>
      </div>
      <div class="product_accordion_main right_item">
        <div class="product_accordion_main_wrapper">
          {% assign MeteTitle = product.metafields.accordion.title %}
          {% assign MeteContent = product.metafields.accordion.content %}
          {% for title in MeteTitle %}
            <div class="accordion_main js-details-tab" data-item-id="{{ forloop.index0 }}">
              {% if title != blank %}
                <details>
                  <summary>
                    <div class="title" id="item--{{ block.id }}" >{{ title }}</div>
                    <div class="product_accordion_icon">
                      {%- render 'icon-round-plus' -%}
                      {%- render 'icon-round-minus' -%}
                    </div>
                  </summary>
                  <div class="accordion_content_main">
                    {% if productMetaAccordions != blank %}                     
                      <div class="image large-up-hide medium-hide" for="item--{{ block.id }}">
                        <img
                          src="{{ productMetaAccordions[forloop.index0][0].original_src }}"
                          alt="{{ block.settings.image.alt }}"
                         image-index="{{ forloop.index0 }}">
                      </div>
                    {% endif %}
                    {% if MeteContent != blank -%}
                      <div class="accordian_content">{{ MeteContent[forloop.index0] }}</div>
                    {% endif %}
                  </div>
                </details>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
<script>
let tabElements = document.querySelectorAll(".js-details-tab");
document.querySelectorAll(".js-image").forEach(function(e) {
    let imageIndex = document.querySelector(".js-image").querySelector("img").getAttribute("image-index");
    if (imageIndex === "0") {
        document.querySelectorAll(".js-image")[0].style.display = "block"
    }
});
tabElements.forEach(function(tabElement) {
    tabElement.addEventListener("click", detailsTabEventHandlers.bind(this), true);
});

function detailsTabEventHandlers(event) {


    tabElements.forEach((tabElement) => {
        if (tabElement.querySelector("details") != event.currentTarget.querySelector("details")) {
            tabElement.querySelector("details").removeAttribute("open")
        }
    })
    let Element = event.currentTarget.querySelector("details")
    let _this = event.currentTarget.closest(".js-details-tab")
    setTimeout(function() {
        if (Element.hasAttribute("open")) {

            let ElementIndex = _this.getAttribute("data-item-id");
            let imageElements = _this.closest(".product_accordion_main").closest(".product_accordion_wrapper").querySelector(".image_wrapper").querySelectorAll(".js-image");
            imageElements.forEach(function(imageElement) {
                let imageIndex = imageElement.querySelector("img").getAttribute("image-index");
                if (ElementIndex === imageIndex) {
                    imageElement.style.display = "block"
                } else {
                    imageElement.style.display = "none"
                }
            })
        }
    }, 10);
}
</script>

{% endif %}

{% schema %}
{
  "name": "Product Accordion",
  "tag": "section",
  "settings": [
    {
        "type":"checkbox",
        "id":"full_width",
        "label":"Full Width",
        "default":true
    },
    {
      "type":"text",
      "id":"image_title",
      "label":"Image Title"
    },
    {
        "type":"image_picker",
        "id":"bg_image",
        "label":"Background Image"
    },
    /*{
        "type":"image_picker",
        "id":"image",
        "label":"Image"
    },*/
    {
        "type":"color_background",
        "id":"bg_color",
        "label":"Background Color"
    },
    {
        "type":"header",
        "content":"Advance"
    },
    {
        "type":"text",
        "id":"add_class",
        "label":"CSS Class"
    },
    {
        "type":"textarea",
        "id":"add_css",
        "label":"Custom CSS"
    }
  ],
  "blocks":[
    {
        "type":"text",
        "name":"Accordion Item",
        "settings":[
            {
                "type":"richtext",
                "id":"title",
                "label":"Title"
            },
            {
                "type":"richtext",
                "id":"text",
                "label":"Text"
            },
            {
                "type":"image_picker",
                "id":"image",
                "label":"Image"
            }
        ]
    }
  ],
  "presets": [
     {
       "name": "Product Accordion",
       "settings": {

        }
     }
   ]
}
{% endschema %}
